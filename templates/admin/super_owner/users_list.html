{% extends "super_owner_base.html" %}

{% block page_title %}Users Management{% endblock %}
{% block page_subtitle %}Manage all users in the system{% endblock %}

{% block main_content %}
<div class="row">
    <div class="col-12">
        <!-- Users Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="badge badge-primary badge-lg">
                            <i class="fas fa-users"></i>
                            {{ total_users }}
                        </div>
                        <p class="text-muted mt-2">Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="badge badge-success badge-lg">
                            <i class="fas fa-user-check"></i>
                            {{ active_users }}
                        </div>
                        <p class="text-muted mt-2">Active Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="badge badge-info badge-lg">
                            <i class="fas fa-crown"></i>
                            {{ super_owners }}
                        </div>
                        <p class="text-muted mt-2">Super Owners</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="badge badge-warning badge-lg">
                            <i class="fas fa-user-plus"></i>
                            {{ new_this_week }}
                        </div>
                        <p class="text-muted mt-2">New This Week</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">
                    <i class="fas fa-users"></i> Users List
                </h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchUsers" placeholder="Search users..." onkeyup="filterUsers()">
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="statusFilter" onchange="filterUsers()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="typeFilter" onchange="filterUsers()">
                            <option value="">All Types</option>
                            <option value="super_owner">Super Owners</option>
                            <option value="company">Company Users</option>
                            <option value="individual">Individuals</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="staffFilter" onchange="filterUsers()">
                            <option value="">All</option>
                            <option value="staff">Staff</option>
                            <option value="superuser">Superusers</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="verifiedFilter" onchange="filterUsers()">
                            <option value="">All</option>
                            <option value="verified">Verified</option>
                            <option value="unverified">Unverified</option>
                        </select>
                    </div>
                </div>

                <!-- Users Table -->
                {% if users %}
                    <div class="admin-table-wrapper">
                        <table class="table table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th>User</th>
                                    <th>Contact</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Companies</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                {% for user in users %}
                                    <tr data-status="{% if user.is_active %}active{% else %}inactive{% endif %}" 
                                        data-type="{% if user.userprofile.is_super_owner %}super_owner{% elif user.userprofile.account_type %}{{ user.userprofile.account_type }}{% else %}individual{% endif %}"
                                        data-staff="{% if user.is_superuser %}superuser{% elif user.is_staff %}staff{% else %}regular{% endif %}"
                                        data-verified="{% if user.userprofile.is_verified %}verified{% else %}unverified{% endif %}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="user-avatar me-2">
                                                    {% if user.userprofile.avatar %}
                                                        <img src="{{ user.userprofile.avatar.url }}" alt="{{ user.get_full_name }}" class="rounded-circle" width="40" height="40">
                                                    {% else %}
                                                        <div class="avatar-placeholder">
                                                            {{ user.first_name.0|default:user.username.0|upper }}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">{{ user.get_full_name|default:user.username }}</h6>
                                                    <small class="text-muted">@{{ user.username }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <div>{{ user.email }}</div>
                                                {% if user.userprofile.phone %}
                                                    <small class="text-muted">{{ user.userprofile.phone }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if user.userprofile.is_super_owner %}
                                                <span class="badge badge-warning">
                                                    <i class="fas fa-crown"></i> Super Owner
                                                </span>
                                            {% elif user.is_superuser %}
                                                <span class="badge badge-danger">
                                                    <i class="fas fa-user-shield"></i> Superuser
                                                </span>
                                            {% elif user.is_staff %}
                                                <span class="badge badge-info">
                                                    <i class="fas fa-user-tie"></i> Staff
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary">
                                                    <i class="fas fa-user"></i> {{ user.userprofile.get_account_type_display|default:"User" }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.is_active %}
                                                {% if user.userprofile.is_verified %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> Active
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-warning">
                                                        <i class="fas fa-clock"></i> Pending
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge badge-danger">
                                                    <i class="fas fa-ban"></i> Inactive
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user.company_memberships.exists %}
                                                <span class="badge badge-light">
                                                    <i class="fas fa-building"></i> {{ user.company_memberships.count }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                {{ user.date_joined|date:"M d, Y" }}<br>
                                                {{ user.date_joined|timesince }} ago
                                            </small>
                                        </td>
                                        <td>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item" href="{% url 'super_owner:user_detail' user.id %}">
                                                        <i class="fas fa-eye"></i> View Details
                                                    </a>
                                                    <a class="dropdown-item" href="#" onclick="toggleUserStatus('{{ user.id }}', {{ user.is_active|yesno:'false,true' }})">
                                                        {% if user.is_active %}
                                                            <i class="fas fa-ban"></i> Deactivate
                                                        {% else %}
                                                            <i class="fas fa-check"></i> Activate
                                                        {% endif %}
                                                    </a>
                                                    {% if not user.userprofile.is_verified %}
                                                        <a class="dropdown-item" href="#" onclick="verifyUser('{{ user.id }}')">
                                                            <i class="fas fa-check-circle"></i> Verify Email
                                                        </a>
                                                    {% endif %}
                                                    <div class="dropdown-divider"></div>
                                                    <a class="dropdown-item" href="/admin/auth/user/{{ user.id }}/change/" target="_blank">
                                                        <i class="fas fa-edit"></i> Edit in Django Admin
                                                    </a>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                        <nav aria-label="Users pagination" class="mt-3">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1">First</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                    </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">
                                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}

                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No users found</h5>
                        <p class="text-muted">No users are registered in the system yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Search and filter functionality
function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const staffFilter = document.getElementById('staffFilter').value;
    const verifiedFilter = document.getElementById('verifiedFilter').value;
    const rows = document.querySelectorAll('#usersTableBody tr');

    rows.forEach(row => {
        const userName = row.querySelector('h6').textContent.toLowerCase();
        const email = row.querySelector('td:nth-child(2) div').textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        const type = row.getAttribute('data-type');
        const staff = row.getAttribute('data-staff');
        const verified = row.getAttribute('data-verified');

        const matchesSearch = userName.includes(searchTerm) || email.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesType = !typeFilter || type === typeFilter;
        const matchesStaff = !staffFilter || staff === staffFilter;
        const matchesVerified = !verifiedFilter || verified === verifiedFilter;

        if (matchesSearch && matchesStatus && matchesType && matchesStaff && matchesVerified) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Export users
function exportUsers() {
    window.location.href = '{% url "super_owner:export_data" "users" %}';
}

// Refresh data
function refreshData() {
    window.location.reload();
}

// Toggle user status
function toggleUserStatus(userId, newStatus) {
    if (confirm('Are you sure you want to ' + (newStatus ? 'activate' : 'deactivate') + ' this user?')) {
        fetch(`{% url 'super_owner:user_toggle_status' '0' %}`.replace('0', userId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'is_active': newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error updating user status: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating user status');
        });
    }
}

// Verify user email
function verifyUser(userId) {
    if (confirm('Are you sure you want to manually verify this user\'s email?')) {
        fetch(`{% url 'super_owner:user_detail' '0' %}`.replace('0', userId) + 'verify/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error verifying user: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while verifying user');
        });
    }
}
</script>

<style>
.avatar-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--admin-accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.125rem;
}

.rounded-circle {
    border-radius: 50%;
}
</style>

<!-- Add CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}
