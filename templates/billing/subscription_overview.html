{% extends 'base.html' %}
{% load static %}

{% block title %}Subscription & Billing - ConstructPro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <div class="page-title">
            <h1><i class="fas fa-credit-card"></i> Subscription & Billing</h1>
            <p>Manage your subscription and view billing information</p>
        </div>
        <div class="page-actions">
            <a href="{% url 'billing:choose_plan' %}" class="btn btn-primary">
                <i class="fas fa-arrow-up"></i> Upgrade Plan
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Subscription -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Current Subscription</h3>
            </div>
            <div class="card-body">
                {% if subscription_info.has_subscription %}
                    <div class="subscription-status">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="subscription-info">
                                    <h4>{{ subscription_info.plan.name }} - {{ subscription_info.plan.get_billing_period_display }}</h4>
                                    <p class="text-muted">{{ subscription_info.plan.description }}</p>
                                    
                                    <div class="subscription-meta">
                                        <span class="badge {% if subscription_info.is_active %}badge-success{% else %}badge-warning{% endif %}">
                                            {{ subscription_info.subscription.get_status_display }}
                                        </span>
                                        
                                        {% if subscription_info.is_active %}
                                            <span class="ms-2">
                                                <i class="fas fa-calendar-alt"></i>
                                                {{ subscription_info.days_remaining }} days remaining
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="subscription-price">
                                    <div class="price-amount">${{ subscription_info.plan.price }}</div>
                                    <div class="price-period">per {{ subscription_info.plan.billing_period }}</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if subscription_info.plan.features %}
                            <div class="subscription-features mt-3">
                                <h6>Plan Features:</h6>
                                <div class="row">
                                    {% for feature in subscription_info.plan.features %}
                                        <div class="col-md-6">
                                            <div class="feature-item">
                                                <i class="fas fa-check-circle text-success"></i>
                                                {{ feature }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="subscription-actions mt-3">
                            <a href="{% url 'billing:choose_plan' %}" class="btn btn-outline-primary">Change Plan</a>
                            {% if subscription_info.subscription.auto_renew %}
                                <form method="post" action="{% url 'billing:cancel_subscription' %}" class="d-inline" 
                                      onsubmit="return confirm('Are you sure you want to cancel your subscription?')">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger">Cancel Subscription</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="no-subscription">
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                            <h4>No Active Subscription</h4>
                            <p class="text-muted">You don't have an active subscription. Choose a plan to get started.</p>
                            <a href="{% url 'billing:choose_plan' %}" class="btn btn-primary">Choose a Plan</a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Billing Summary -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Billing Summary</h3>
            </div>
            <div class="card-body">
                {% if recent_payments %}
                    <div class="billing-summary">
                        <div class="summary-item">
                            <div class="summary-label">Last Payment</div>
                            <div class="summary-value">
                                ${{ recent_payments.0.amount }}
                                <small class="text-muted">{{ recent_payments.0.created_at|date:"M j, Y" }}</small>
                            </div>
                        </div>
                        
                        <div class="summary-item">
                            <div class="summary-label">Payment Method</div>
                            <div class="summary-value">{{ recent_payments.0.get_payment_method_display }}</div>
                        </div>
                        
                        <div class="summary-item">
                            <div class="summary-label">Next Billing</div>
                            <div class="summary-value">
                                {% if subscription_info.subscription.end_date %}
                                    {{ subscription_info.subscription.end_date|date:"M j, Y" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{% url 'billing:billing_history' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-history"></i> View All History
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-receipt text-muted fa-2x mb-2"></i>
                        <p class="text-muted">No payment history</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Account Type -->
        <div class="card mt-3">
            <div class="card-body">
                <div class="account-type">
                    <div class="account-type-icon">
                        {% if is_company %}
                            <i class="fas fa-building text-primary"></i>
                        {% else %}
                            <i class="fas fa-user text-success"></i>
                        {% endif %}
                    </div>
                    <div class="account-type-info">
                        <h6>{{ user.get_full_name|default:user.username }}</h6>
                        <p class="text-muted mb-0">
                            {% if is_company %}
                                Company Account
                            {% else %}
                                Individual Account
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Payments -->
{% if recent_payments %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Recent Payments</h3>
                <a href="{% url 'billing:billing_history' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in recent_payments %}
                            <tr>
                                <td>{{ payment.created_at|date:"M j, Y" }}</td>
                                <td>${{ payment.amount }}</td>
                                <td>{{ payment.get_payment_method_display }}</td>
                                <td>
                                    <span class="badge {% if payment.status == 'completed' %}badge-success{% elif payment.status == 'pending' %}badge-warning{% else %}badge-danger{% endif %}">
                                        {{ payment.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    {% if payment.invoice %}
                                        <a href="#" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.subscription-status {
    padding: 20px 0;
}

.subscription-price {
    text-align: right;
}

.price-amount {
    font-size: 2rem;
    font-weight: bold;
    color: var(--accent-600);
}

.price-period {
    color: var(--gray-600);
    font-size: 0.875rem;
}

.subscription-features {
    border-top: 1px solid var(--gray-200);
    padding-top: 20px;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.billing-summary .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--gray-200);
}

.billing-summary .summary-item:last-child {
    border-bottom: none;
}

.summary-label {
    font-weight: 500;
    color: var(--gray-700);
}

.summary-value {
    text-align: right;
    color: var(--gray-900);
}

.account-type {
    display: flex;
    align-items: center;
    gap: 15px;
}

.account-type-icon {
    font-size: 1.5rem;
}

.no-subscription {
    text-align: center;
    padding: 40px 20px;
}
</style>
{% endblock %}
