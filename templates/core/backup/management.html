{% extends 'super_owner_base.html' %}
{% load static %}

{% block title %}Backup Management - Construction Tracker{% endblock %}
{% block page_title %}Backup & Restore{% endblock %}
{% block page_subtitle %}System Data Management{% endblock %}

{% block main_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Backup Management</h1>
                    <p class="text-muted">Create and manage local backups of your data</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                        <i class="fas fa-plus me-2"></i>Create Backup
                    </button>
                    {% if is_super_owner %}
                    <button type="button" class="btn btn-outline-warning ms-2" onclick="cleanupOldBackups()">
                        <i class="fas fa-broom me-2"></i>Cleanup Old
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Backup Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-archive fa-2x opacity-75"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0" id="backup-count">{{ backups|length }}</h5>
                                    <p class="card-text mb-0">Total Backups</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-hdd fa-2x opacity-75"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0" id="total-size">...</h5>
                                    <p class="card-text mb-0">Total Size</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-clock fa-2x opacity-75"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0" id="last-backup">...</h5>
                                    <p class="card-text mb-0">Last Backup</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                                </div>
                                <div>
                                    <h5 class="card-title mb-0">
                                        {% if is_super_owner %}System{% elif is_company_admin %}Company{% else %}User{% endif %}
                                    </h5>
                                    <p class="card-text mb-0">Backup Level</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup List -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Available Backups</h5>
                </div>
                <div class="card-body">
                    {% if backups %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for backup in backups %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-archive text-primary me-2"></i>
                                            <span class="fw-medium">{{ backup.filename }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        {% if backup.filename|slice:":6" == "system" %}
                                            <span class="badge bg-danger">System</span>
                                        {% elif backup.filename|slice:":7" == "company" %}
                                            <span class="badge bg-success">Company</span>
                                        {% elif backup.filename|slice:":4" == "user" %}
                                            <span class="badge bg-info">User</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ backup.size|filesizeformat }}</td>
                                    <td>{{ backup.created_at|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if backup.can_download %}
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'core:download_backup' backup.filename %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i>Download
                                            </a>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-danger" 
                                                    onclick="deleteBackup('{{ backup.filename }}')">
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-lock me-1"></i>No access
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-archive fa-3x text-muted mb-3"></i>
                        <h5>No Backups Found</h5>
                        <p class="text-muted">Create your first backup to get started.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createBackupModal">
                            <i class="fas fa-plus me-2"></i>Create First Backup
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Backup Modal -->
<div class="modal fade" id="createBackupModal" tabindex="-1" aria-labelledby="createBackupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createBackupModalLabel">Create New Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="backupForm">
                    <div class="mb-3">
                        <label for="backup-type" class="form-label">Backup Type</label>
                        <select class="form-select" id="backup-type" name="type">
                            {% for value, label in backup_types %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <strong>Basic:</strong> Essential data only (faster)<br>
                            <strong>Full:</strong> Includes all documents and files (larger)
                        </div>
                    </div>

                    {% if is_super_owner %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        As a Super Owner, you can create comprehensive system backups including all companies, users, and system data.
                    </div>
                    {% elif is_company_admin %}
                    <div class="alert alert-success">
                        <i class="fas fa-building me-2"></i>
                        As a Company Admin, you can backup all data for companies you manage.
                    </div>
                    {% else %}
                    <div class="alert alert-primary">
                        <i class="fas fa-user me-2"></i>
                        You can backup your personal data and notifications.
                    </div>
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createBackup()">
                    <i class="fas fa-archive me-2"></i>Create Backup
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function createBackup() {
    const type = document.getElementById('backup-type').value;
    const createModal = bootstrap.Modal.getInstance(document.getElementById('createBackupModal'));
    
    createModal.hide();
    
    fetch('{% url "core:create_backup" %}?type=' + type, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Backup created successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', 'Backup creation failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        showAlert('danger', 'Network error: ' + error.message);
    });
}

function deleteBackup(filename) {
    if (!confirm('Are you sure you want to delete this backup?')) {
        return;
    }
    
    fetch('{% url "core:delete_backup" "FILENAME" %}'.replace('FILENAME', filename), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Backup deleted successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', 'Delete failed: ' + data.error);
        }
    })
    .catch(error => {
        showAlert('danger', 'Network error: ' + error.message);
    });
}

{% if is_super_owner %}
function cleanupOldBackups() {
    const days = prompt('Delete backups older than how many days?', '30');
    if (!days || isNaN(days)) return;
    
    if (!confirm(`Delete all backups older than ${days} days?`)) return;
    
    fetch('{% url "core:cleanup_old_backups" %}?days=' + days)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert('danger', 'Cleanup failed: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('danger', 'Network error: ' + error.message);
        });
}
{% endif %}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
}
</script>
{% endblock main_content %}
