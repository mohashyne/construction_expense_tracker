{% extends 'base.html' %}

{% block title %}Reports & Analytics - ConstructPro{% endblock %}

{% block page_title %}Reports & Analytics{% endblock %}
{% block page_subtitle %}Comprehensive insights into your construction business performance{% endblock %}

{% block content %}
<!-- Page header -->
<div class="d-flex justify-between align-center mb-4">
    <div>
        <h2>Business Analytics</h2>
        <p class="text-muted">Track performance metrics and generate comprehensive reports</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary">
            <i class="fas fa-download"></i>
            Export Report
        </button>
        <button type="button" class="btn btn-outline-secondary">
            <i class="fas fa-print"></i>
            Print
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col col-3">
        <div class="card">
            <div class="card-stat">
                <div class="card-stat-icon" style="background: var(--accent-100); color: var(--accent-600);">
                    <i class="fas fa-building"></i>
                </div>
                <div class="card-stat-value text-primary">{{ total_projects|default:"0" }}</div>
                <div class="card-stat-label">Total Projects</div>
            </div>
            <div class="card-footer">
                <span class="text-muted fw-medium">All time</span>
            </div>
        </div>
    </div>
    
    <div class="col col-3">
        <div class="card">
            <div class="card-stat">
                <div class="card-stat-icon" style="background: var(--accent-100); color: var(--accent-600);">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="card-stat-value text-success">
                    <span class="currency-symbol">₦</span><span class="currency-value" data-usd="{{ total_expenses|default:"0" }}" data-ngn="{{ total_expenses|default:"0" }}">{{ total_expenses|floatformat:0|default:"0" }}</span>
                </div>
                <div class="card-stat-label">Total Expenses</div>
            </div>
            <div class="card-footer">
                <span class="text-muted fw-medium">Across all projects</span>
            </div>
        </div>
    </div>
    
    <div class="col col-3">
        <div class="card">
            <div class="card-stat">
                <div class="card-stat-icon" style="background: var(--yellow-100); color: var(--yellow-600);">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="card-stat-value text-warning">
                    <span class="currency-symbol">₦</span><span class="currency-value" data-usd="{{ total_budget|default:"0" }}" data-ngn="{{ total_budget|default:"0" }}">{{ total_budget|floatformat:0|default:"0" }}</span>
                </div>
                <div class="card-stat-label">Total Budget</div>
            </div>
            <div class="card-footer">
                <span class="text-muted fw-medium">Allocated budget</span>
            </div>
        </div>
    </div>
    
    <div class="col col-3">
        <div class="card">
            <div class="card-stat">
                <div class="card-stat-icon" style="background: var(--red-100); color: var(--red-600);">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="card-stat-value text-danger">
                    {{ projects_by_status.count|default:"0" }}
                </div>
                <div class="card-stat-label">Active Categories</div>
            </div>
            <div class="card-footer">
                <span class="text-muted fw-medium">Project statuses</span>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
    <!-- Monthly Expense Trend Chart -->
    <div class="col col-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Monthly Expense Trend</h5>
                <p class="text-muted mb-0">Track spending patterns over the last 12 months</p>
            </div>
            <div class="card-body">
                <canvas id="monthlyExpenseChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Project Status Distribution -->
    <div class="col col-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Project Status Distribution</h5>
                <p class="text-muted mb-0">Overview of current project statuses</p>
            </div>
            <div class="card-body">
                <canvas id="projectStatusChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Project Status Breakdown -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Project Status Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for status in projects_by_status %}
                    <div class="col col-2">
                        <div class="text-center p-3">
                            <div class="fw-bold" style="font-size: 1.5rem;">{{ status.count }}</div>
                            <div class="text-muted">{{ status.status|title }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-4">
                        <p class="text-muted">No project data available</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Monthly Breakdown</h5>
                <p class="text-muted mb-0">Detailed monthly expense and project data</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Expenses</th>
                                <th>Projects Started</th>
                                <th>Projects Completed</th>
                                <th>Budget Utilization</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month_data in monthly_data %}
                            <tr>
                                <td class="fw-medium">{{ month_data.month }}</td>
                                <td>
                                    <span class="currency-symbol">₦</span><span class="currency-value" data-usd="{{ month_data.expenses }}" data-ngn="{{ month_data.expenses }}">{{ month_data.expenses|floatformat:0 }}</span>
                                </td>
                                <td>{{ month_data.projects_started|default:"0" }}</td>
                                <td>{{ month_data.projects_completed|default:"0" }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" style="width: {{ month_data.budget_utilization|default:"0" }}%;">
                                            {{ month_data.budget_utilization|default:"0" }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">No data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Monthly Expense Chart
    const monthlyCtx = document.getElementById('monthlyExpenseChart');
    if (monthlyCtx) {
        const monthlyData = {{ monthly_data|safe }};
        
        new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: monthlyData.map(item => item.month),
                datasets: [{
                    label: 'Monthly Expenses',
                    data: monthlyData.map(item => item.expenses),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    fill: true,
                    pointBackgroundColor: 'rgb(59, 130, 246)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '₦' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Project Status Chart
    const statusCtx = document.getElementById('projectStatusChart');
    if (statusCtx) {
        const statusData = {{ projects_by_status|safe }};
        
        const statusColors = {
            'planning': '#6B7280',
            'in_progress': '#3B82F6',
            'on_hold': '#F59E0B',
            'completed': '#10B981',
            'cancelled': '#EF4444'
        };
        
        const statusLabels = {
            'planning': 'Planning',
            'in_progress': 'In Progress',
            'on_hold': 'On Hold',
            'completed': 'Completed',
            'cancelled': 'Cancelled'
        };
        
        if (statusData.length > 0) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusData.map(item => statusLabels[item.status] || item.status),
                    datasets: [{
                        data: statusData.map(item => item.count),
                        backgroundColor: statusData.map(item => statusColors[item.status] || '#6B7280'),
                        borderWidth: 3,
                        borderColor: '#fff',
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        } else {
            statusCtx.getContext('2d').fillStyle = '#F3F4F6';
            statusCtx.getContext('2d').fillRect(0, 0, statusCtx.width, statusCtx.height);
            statusCtx.insertAdjacentHTML('afterend', '<div class="text-center py-8 text-gray-500"><i class="fas fa-chart-pie text-3xl mb-2"></i><br>No project data available</div>');
        }
    }
});
</script>
{% endblock %}
